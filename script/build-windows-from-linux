#!/usr/bin/env bash

set -euo pipefail

architecture="x86_64"
install_dependencies=false

function find_tool() {
  local tool_name="$1"
  local candidate=""

  if command -v "$tool_name" >/dev/null 2>&1; then
    command -v "$tool_name"
    return 0
  fi

  for candidate in \
    "/usr/bin/${tool_name}-"* \
    "/usr/lib64/llvm"*/bin/"$tool_name" \
    "/usr/lib/llvm"*/bin/"$tool_name" \
    "/usr/lib64/llvm"*/bin/"${tool_name}-"* \
    "/usr/lib/llvm"*/bin/"${tool_name}-"*; do
    if [[ -x "$candidate" ]]; then
      echo "$candidate"
      return 0
    fi
  done

  return 1
}

function help_info() {
  cat <<'EOF'
Usage: script/build-windows-from-linux [options]

Cross-build Windows binaries from Linux using cargo-xwin.
This does not produce the Windows installer .exe (Inno Setup step is Windows-only).

Options:
  --arch <x86_64|aarch64>  Target architecture (default: x86_64)
  --install-deps           Install required openSUSE packages with zypper
  -h, --help               Show this help
EOF
}

while [[ $# -gt 0 ]]; do
  case "$1" in
    --arch)
      architecture="${2:-}"
      shift 2
      ;;
    --install-deps)
      install_dependencies=true
      shift
      ;;
    -h|--help)
      help_info
      exit 0
      ;;
    *)
      echo "Unknown argument: $1"
      help_info
      exit 1
      ;;
  esac
done

case "$architecture" in
  x86_64)
    target_triple="x86_64-pc-windows-msvc"
    ;;
  aarch64)
    target_triple="aarch64-pc-windows-msvc"
    ;;
  *)
    echo "Unsupported architecture: $architecture"
    exit 1
    ;;
esac

if [[ ! -f "Cargo.toml" ]] || [[ ! -d "crates/zed" ]]; then
  echo "Run this script from the repository root."
  exit 1
fi

if [[ "$install_dependencies" == true ]]; then
  if ! command -v zypper >/dev/null 2>&1; then
    echo "--install-deps is currently implemented for openSUSE (zypper)."
    exit 1
  fi

  # Packages required for cross-building Windows binaries on openSUSE.
  sudo zypper install -y \
    alsa-devel clang lld llvm cmake fontconfig-devel gcc gcc-c++ git gzip jq \
    libvulkan1 libx11-devel libxcb-devel libxkbcommon-devel libxkbcommon-x11-devel \
    libzstd-devel make mold openssl-devel sqlite3-devel tar wayland-devel xcb-util-devel \
    pkgconf curl
fi

if ! command -v rustup >/dev/null 2>&1; then
  echo "rustup is required."
  exit 1
fi

if ! cargo xwin --version >/dev/null 2>&1; then
  cargo install cargo-xwin
fi

rustup target add "$target_triple"

cache_directory="${XDG_CACHE_HOME:-$HOME/.cache}/cargo-xwin"
mkdir -p "$cache_directory"
export XWIN_CACHE_DIR="$cache_directory"

wrapper_directory="${XDG_CACHE_HOME:-$HOME/.cache}/nano-zed/windows-toolchain/bin"
mkdir -p "$wrapper_directory"

clang_cl_binary="$(find_tool clang-cl || true)"
if [[ -z "$clang_cl_binary" ]]; then
  clang_binary="$(find_tool clang || true)"
  if [[ -z "$clang_binary" ]]; then
    echo "Missing both clang-cl and clang."
    echo "Install LLVM first (openSUSE: sudo zypper install clang lld llvm)."
    exit 1
  fi

  clang_cl_binary="$wrapper_directory/clang-cl"
  cat > "$clang_cl_binary" <<EOF
#!/usr/bin/env bash
exec "$clang_binary" --driver-mode=cl "\$@"
EOF
  chmod +x "$clang_cl_binary"
fi

llvm_lib_binary="$(find_tool llvm-lib || true)"
if [[ -z "$llvm_lib_binary" ]]; then
  echo "Missing llvm-lib."
  echo "Install LLVM tools (openSUSE: sudo zypper install llvm clang lld)."
  exit 1
fi

export CC_x86_64_pc_windows_msvc="$clang_cl_binary"
export CC_aarch64_pc_windows_msvc="$clang_cl_binary"
export CXX_x86_64_pc_windows_msvc="$clang_cl_binary"
export CXX_aarch64_pc_windows_msvc="$clang_cl_binary"
export AR_x86_64_pc_windows_msvc="$llvm_lib_binary"
export AR_aarch64_pc_windows_msvc="$llvm_lib_binary"

echo "Building Windows binaries for $target_triple"
cargo xwin build --release --target "$target_triple" \
  --package zed \
  --package cli \
  --package auto_update_helper \
  --package remote_server

output_directory="${CARGO_TARGET_DIR:-target}/$target_triple/release"
echo
echo "Build complete. Artifacts:"
echo "  $output_directory/zed.exe"
echo "  $output_directory/cli.exe"
echo "  $output_directory/auto_update_helper.exe"
echo "  $output_directory/remote_server.exe"
