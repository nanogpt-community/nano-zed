name: release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (for example: v0.1.0 or 0.1.0)"
        required: true
        type: string
      platform:
        description: "Platform to build"
        required: false
        type: choice
        default: all
        options:
          - all
          - linux
          - macos
          - windows

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  build_installers:
    strategy:
      fail-fast: false
      matrix:
        include: ${{ fromJSON(github.event_name == 'workflow_dispatch' && github.event.inputs.platform == 'linux' && '[{"platform":"linux","runner":"blacksmith-8vcpu-ubuntu-2404","artifact_file":"nano-zed-linux-x86_64.tar.gz"}]' || github.event_name == 'workflow_dispatch' && github.event.inputs.platform == 'macos' && '[{"platform":"macos","runner":"macos-latest","artifact_file":"nano-zed-macos-aarch64.dmg"}]' || github.event_name == 'workflow_dispatch' && github.event.inputs.platform == 'windows' && '[{"platform":"windows","runner":"blacksmith-8vcpu-windows-2025","artifact_file":"nano-zed-windows-x86_64.exe"}]' || '[{"platform":"linux","runner":"blacksmith-8vcpu-ubuntu-2404","artifact_file":"nano-zed-linux-x86_64.tar.gz"},{"platform":"macos","runner":"macos-latest","artifact_file":"nano-zed-macos-aarch64.dmg"},{"platform":"windows","runner":"blacksmith-8vcpu-windows-2025","artifact_file":"nano-zed-windows-x86_64.exe"}]') }}

    runs-on: ${{ matrix.runner }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure Windows cargo paths
        if: matrix.platform == 'windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path 'C:\.cargo' -Force | Out-Null
          New-Item -ItemType Directory -Path 'C:\.rustup' -Force | Out-Null
          New-Item -ItemType Directory -Path 'C:\t' -Force | Out-Null
          "CARGO_HOME=C:\.cargo" >> $env:GITHUB_ENV
          "RUSTUP_HOME=C:\.rustup" >> $env:GITHUB_ENV
          "CARGO_TARGET_DIR=C:\t" >> $env:GITHUB_ENV
          "CARGO_NET_GIT_FETCH_WITH_CLI=true" >> $env:GITHUB_ENV
          git config --global core.longpaths true

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: 1.93

      - name: Cache Rust build
        uses: Swatinem/rust-cache@v2

      - name: Verify Linux x64 runner
        if: matrix.platform == 'linux'
        shell: bash
        run: |
          set -euxo pipefail
          test "$(uname -m)" = "x86_64"

      - name: Verify macOS arm64 runner
        if: matrix.platform == 'macos'
        shell: bash
        run: |
          set -euxo pipefail
          test "$(uname -m)" = "arm64"

      - name: Select Xcode 16.2
        if: matrix.platform == 'macos'
        shell: bash
        run: |
          set -euxo pipefail
          echo "DEVELOPER_DIR=/Applications/Xcode_16.2.app/Contents/Developer" >> "$GITHUB_ENV"
          /Applications/Xcode_16.2.app/Contents/Developer/usr/bin/xcodebuild -version

      - name: Verify Windows x64 runner
        if: matrix.platform == 'windows'
        shell: pwsh
        run: |
          if ($env:PROCESSOR_ARCHITECTURE -ne 'AMD64') {
            throw "Expected AMD64 runner, got $env:PROCESSOR_ARCHITECTURE"
          }

      - name: Ensure Inno Setup is installed
        if: matrix.platform == 'windows'
        shell: pwsh
        run: |
          if (-not (Get-Command "iscc.exe" -ErrorAction SilentlyContinue)) {
            if (Get-Command "choco.exe" -ErrorAction SilentlyContinue) {
              choco install innosetup --no-progress -y
            }
          }

          if (-not (Get-Command "iscc.exe" -ErrorAction SilentlyContinue)) {
            if (Get-Command "winget.exe" -ErrorAction SilentlyContinue) {
              winget install --id JRSoftware.InnoSetup -e --silent --accept-source-agreements --accept-package-agreements
            }
          }

          $iscc = Get-Command "iscc.exe" -ErrorAction SilentlyContinue
          if (-not $iscc) {
            throw "Inno Setup ISCC.exe is not available on this runner."
          }
          Write-Output "Using ISCC at $($iscc.Source)"

      - name: Setup Node.js (macOS for DMG tooling)
        if: matrix.platform == 'macos'
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Linux dependencies
        if: matrix.platform == 'linux'
        shell: bash
        run: |
          set -euxo pipefail
          ./script/linux
          ./script/download-wasi-sdk

      - name: Build Linux installer bundle (unsigned)
        if: matrix.platform == 'linux'
        shell: bash
        run: |
          set -euxo pipefail
          ./script/bundle-linux
          mkdir -p dist
          cp target/release/zed-linux-x86_64.tar.gz dist/${{ matrix.artifact_file }}

      - name: Build macOS installer bundle (unsigned)
        if: matrix.platform == 'macos'
        shell: bash
        run: |
          set -euxo pipefail
          ./script/bundle-mac aarch64-apple-darwin
          mkdir -p dist
          cp target/aarch64-apple-darwin/release/Zed-aarch64.dmg dist/${{ matrix.artifact_file }}

      - name: Build Windows installer bundle (unsigned)
        if: matrix.platform == 'windows'
        shell: pwsh
        env:
          CI: ""
          MSVC_SPECTRE_LIBS_ALLOW_MISSING: "1"
        run: |
          script/bundle-windows.ps1 -Architecture x86_64
          New-Item -Path dist -ItemType Directory -Force | Out-Null
          Copy-Item -Path target/Zed-x86_64.exe -Destination dist/${{ matrix.artifact_file }} -Force

      - name: Upload installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_file }}
          path: dist/${{ matrix.artifact_file }}
          if-no-files-found: error

  release:
    needs: build_installers
    runs-on: blacksmith-8vcpu-ubuntu-2404

    steps:
      - name: Resolve release tag
        id: resolve_tag
        shell: bash
        env:
          MANUAL_VERSION: ${{ github.event.inputs.version }}
        run: |
          set -euo pipefail
          if [[ "${GITHUB_EVENT_NAME}" == "push" ]]; then
            tag="${GITHUB_REF_NAME}"
          else
            tag="${MANUAL_VERSION}"
            if [[ "${tag}" != v* ]]; then
              tag="v${tag}"
            fi
          fi

          if [[ ! "${tag}" =~ ^v.+ ]]; then
            echo "Invalid release tag: ${tag}"
            exit 1
          fi

          echo "tag=${tag}" >> "$GITHUB_OUTPUT"

      - name: Download installer artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: Show artifacts
        run: ls -lah dist

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.resolve_tag.outputs.tag }}
          target_commitish: ${{ github.sha }}
          files: dist/*
          generate_release_notes: true
