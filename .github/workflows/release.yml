name: release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  build_installers:
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: linux
            runner: ubuntu-22.04
            artifact_file: nano-zed-linux-x86_64.tar.gz
          - platform: macos
            runner: macos-14
            artifact_file: nano-zed-macos-aarch64.dmg
          - platform: windows
            runner: windows-2022
            artifact_file: nano-zed-windows-x86_64.exe

    runs-on: ${{ matrix.runner }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: 1.93

      - name: Cache Rust build
        uses: Swatinem/rust-cache@v2

      - name: Verify Linux x64 runner
        if: matrix.platform == 'linux'
        shell: bash
        run: |
          set -euxo pipefail
          test "$(uname -m)" = "x86_64"

      - name: Verify macOS arm64 runner
        if: matrix.platform == 'macos'
        shell: bash
        run: |
          set -euxo pipefail
          test "$(uname -m)" = "arm64"

      - name: Verify Windows x64 runner
        if: matrix.platform == 'windows'
        shell: pwsh
        run: |
          if ($env:PROCESSOR_ARCHITECTURE -ne 'AMD64') {
            throw "Expected AMD64 runner, got $env:PROCESSOR_ARCHITECTURE"
          }

      - name: Setup Node.js (macOS for DMG tooling)
        if: matrix.platform == 'macos'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Linux dependencies
        if: matrix.platform == 'linux'
        shell: bash
        run: |
          set -euxo pipefail
          ./script/linux
          ./script/download-wasi-sdk

      - name: Build Linux installer bundle (unsigned)
        if: matrix.platform == 'linux'
        shell: bash
        run: |
          set -euxo pipefail
          ./script/bundle-linux
          mkdir -p dist
          cp target/release/zed-linux-x86_64.tar.gz dist/${{ matrix.artifact_file }}

      - name: Build macOS installer bundle (unsigned)
        if: matrix.platform == 'macos'
        shell: bash
        run: |
          set -euxo pipefail
          ./script/bundle-mac aarch64-apple-darwin
          mkdir -p dist
          cp target/aarch64-apple-darwin/release/Zed-aarch64.dmg dist/${{ matrix.artifact_file }}

      - name: Build Windows installer bundle (unsigned)
        if: matrix.platform == 'windows'
        shell: pwsh
        env:
          CI: ""
        run: |
          script/bundle-windows.ps1 -Architecture x86_64
          New-Item -Path dist -ItemType Directory -Force | Out-Null
          Copy-Item -Path target/Zed-x86_64.exe -Destination dist/${{ matrix.artifact_file }} -Force

      - name: Upload installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_file }}
          path: dist/${{ matrix.artifact_file }}
          if-no-files-found: error

  release:
    needs: build_installers
    runs-on: ubuntu-22.04

    steps:
      - name: Download installer artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: Show artifacts
        run: ls -lah dist

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*
          generate_release_notes: true
